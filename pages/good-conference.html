<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è - Insight Room</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/conference.css') }}">
</head>
<body data-user-name="{{ user_name }}">
    <div class="animated-bg"></div>
    
    <header class="header">
        <div class="container">
            <div class="logo">
                <a href="/" class="logo-link">Insight Room</a>
            </div>
            <nav class="nav">
                <div class="meeting-info">
                    <span id="meetingId">ID: {{ room_url }}</span>
                    <span id="meetingTimer">‚è∞ 00:00:00</span>
                    <span id="participantCount">üë• 1</span>
                </div>
            </nav>
        </div>
    </header>

    <main class="main conference-main">
        <div class="conference-layout">
            <!-- –ö–Ω–æ–ø–∫–∞ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ (–≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö) -->
            <button class="expand-left-panel" id="expandLeftPanel" title="–ü–æ–∫–∞–∑–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤">
                <img src="{{ url_for('static', filename='images/contacts-icon.png') }}" alt="–£—á–∞—Å—Ç–Ω–∏–∫–∏">
            </button>

            <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - –≤–∏–¥–µ–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–≤—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –≤–∫–ª—é—á–∞—è —Å–µ–±—è) -->
            <div class="left-panel" id="leftPanel">
                <div class="video-panel-header">
                    <h3 class="video-panel-title">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
                </div>
                <div class="video-participants-grid" id="videoParticipantsList">
                    <!-- –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -->
                    <div class="video-participant-card" id="participant-local">
                        <div class="video-placeholder">
                            <div class="participant-avatar">{{ user_name[:2]|upper if user_name else '–£–ß' }}</div>
                            <video id="localVideoThumbnail" autoplay playsinline muted style="display: none;"></video>
                        </div>
                        <div class="participant-name">{{ user_name or '–í—ã' }}</div>
                        <div class="participant-status">
                            <img src="{{ url_for('static', filename='images/mic-off.png') }}" alt="–ú–∏–∫—Ä–æ—Ñ–æ–Ω" class="status-icon muted" id="localAudioStatus">
                            <img src="{{ url_for('static', filename='images/camera-off.png') }}" alt="–ö–∞–º–µ—Ä–∞" class="status-icon muted" id="localVideoStatus">
                        </div>
                    </div>
                </div>
            </div>

            <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å - –≥–ª–∞–≤–Ω–æ–µ –≤–∏–¥–µ–æ -->
            <div class="center-panel" id="centerPanel">
                <div class="main-video-container" id="mainVideoContainer">
                    <div class="video-placeholder active" id="mainVideoPlaceholder">
                        <div class="placeholder-content">
                            <div class="user-avatar large" id="mainUserAvatar">{{ user_name[:2]|upper if user_name else '–£' }}</div>
                            <div class="user-name" id="mainUserName">{{ user_name or '–£—á–∞—Å—Ç–Ω–∏–∫' }}</div>
                            <div class="user-status">–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞</div>
                        </div>
                    </div>
                    <video id="mainVideo" class="main-video" autoplay playsinline></video>
                    <video id="screenShareVideo" class="main-video" autoplay playsinline style="display: none;"></video>

                    <!-- –î–æ–±–∞–≤–ª—è–µ–º iframe –¥–ª—è Excalidraw —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é -->
                    <iframe 
                        id="whiteboardFrame" 
                        src="https://excalidraw.com/" 
                        style="display: none; width: 100%; height: 100%; border: none; border-radius: 8px;"
                        allow="clipboard-read; clipboard-write"
                        sandbox="allow-scripts allow-same-origin allow-popups allow-forms"
                        title="–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ—Å–∫–∞"
                    ></iframe>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - —á–∞—Ç –∏ —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
            <div class="right-panel">
                <!-- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
                <div class="sidebar" id="participantsListSidebar">
                    <div class="sidebar-header">
                        <h3 class="sidebar-title">–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (<span id="participantsCount">1</span>)</h3>
                    </div>
                    <div class="participants-list" id="participantsList">
                        <!-- –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -->
                        <div class="participant-list-item local-user" id="list-item-local">
                            <div class="participant-info">
                                <div class="participant-details">
                                    <div class="participant-name">{{ user_name or '–í—ã' }}</div>
                                </div>
                                <div class="participant-controls">
                                    <img src="{{ url_for('static', filename='images/mic-off.png') }}" alt="–ú–∏–∫—Ä–æ—Ñ–æ–Ω" class="status-icon" id="listAudioStatus">
                                    <img src="{{ url_for('static', filename='images/camera-off.png') }}" alt="–ö–∞–º–µ—Ä–∞" class="status-icon" id="listVideoStatus">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ß–∞—Ç (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                <div class="sidebar" id="chatSidebar" style="display: none;">
                    <div class="sidebar-header">
                        <h3 class="sidebar-title">–ß–∞—Ç –≤—Å—Ç—Ä–µ—á–∏</h3>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleChatInputKeypress(event)">
                        <button class="send-btn" id="sendMessage" onclick="sendChatMessage()">
                            <img src="{{ url_for('static', filename='images/send-message-icon.png') }}" alt="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="control-panel">
            <button class="control-btn muted" id="toggleAudio" title="–ú–∏–∫—Ä–æ—Ñ–æ–Ω">
                <img src="{{ url_for('static', filename='images/mic-off.png') }}" alt="–ú–∏–∫—Ä–æ—Ñ–æ–Ω" class="control-icon" id="toggleAudioIcon">
            </button>
            
            <button class="control-btn muted" id="toggleVideo" title="–ö–∞–º–µ—Ä–∞">
                <img src="{{ url_for('static', filename='images/camera-off.png') }}" alt="–ö–∞–º–µ—Ä–∞" class="control-icon" id="toggleVideoIcon">
            </button>
            
            <button class="control-btn" id="toggleScreen" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —ç–∫—Ä–∞–Ω–æ–º">
                <img src="{{ url_for('static', filename='images/screen-share.png') }}" alt="–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞" class="control-icon" id="toggleScreenIcon">
            </button>

            <div class="control-separator"></div>

            <button class="control-btn" id="toggleWhiteboardBtn" title="–î–æ—Å–∫–∞">
                <img src="{{ url_for('static', filename='images/whiteboard-new-icon.png') }}" alt="–î–æ—Å–∫–∞" class="control-icon">
            </button>

            <button class="control-btn" id="toggleChatBtn" title="–ß–∞—Ç">
                <img src="{{ url_for('static', filename='images/chat-new-icon.png') }}" alt="–ß–∞—Ç" class="control-icon">
            </button>

            <div class="control-separator"></div>
            
            <button class="control-btn danger" id="leaveCall" title="–ü–æ–∫–∏–Ω—É—Ç—å –≤—Å—Ç—Ä–µ—á—É">
                <img src="{{ url_for('static', filename='images/leave-call.png') }}" alt="–ü–æ–∫–∏–Ω—É—Ç—å –≤—Å—Ç—Ä–µ—á—É" class="control-icon">
            </button>
        </div>
    </main>

    <!-- SocketIO –∫–ª–∏–µ–Ω—Ç -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='js/conference.js') }}"></script>
    
    <!-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å —á–µ—Ç–∫–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
        let localStream = null;
        let screenStream = null;
        let meetingStartTime = Date.now();
        let audioContext = null;
        let analyser = null;
        let speakingCheckInterval = null;
        
        // –°–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–¥–∏–∞
        let mediaState = {
            audioEnabled: false,
            videoEnabled: false,
            screenSharing: false,
            whiteboardActive: false  // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏
        };

        // –¢–∞–π–º–µ—Ä –≤—Å—Ç—Ä–µ—á–∏
        function updateMeetingTimer() {
            const now = Date.now();
            const diff = now - meetingStartTime;
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            
            const timerElement = document.getElementById('meetingTimer');
            if (timerElement) {
                timerElement.textContent = '‚è∞ ' + hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
            }
        }
        
        setInterval(updateMeetingTimer, 1000);

        // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            // –°—Ä–∞–∑—É —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∫—Ä–∞—Å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            forceRedButtons();
            initializeMedia();
            setupUIHandlers();
            setupAdaptiveLayout();
            updateParticipantCount();
            setupAudioAnalysis();
        });

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∫—Ä–∞—Å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        function forceRedButtons() {
            const toggleAudioBtn = document.getElementById('toggleAudio');
            const toggleVideoBtn = document.getElementById('toggleVideo');
            
            if (toggleAudioBtn) {
                toggleAudioBtn.classList.add('muted');
            }
            if (toggleVideoBtn) {
                toggleVideoBtn.classList.add('muted');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–¥–∏–∞
        async function initializeMedia() {
            try {
                console.log('–ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –Ω–∞ –º–µ–¥–∏–∞...');
                
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                    }
                });

                console.log('–ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω:', localStream);

                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –≤–∏–¥–µ–æ
                const mainVideo = document.getElementById('mainVideo');
                const mainPlaceholder = document.getElementById('mainVideoPlaceholder');
                const localVideoThumbnail = document.getElementById('localVideoThumbnail');
                
                if (mainVideo) {
                    mainVideo.srcObject = localStream;
                    mainVideo.onloadeddata = () => {
                        // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –∫–∞–º–µ—Ä–∞ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω—ã
                        const videoTrack = localStream.getVideoTracks()[0];
                        const audioTrack = localStream.getAudioTracks()[0];
                        
                        if (videoTrack) videoTrack.enabled = false;
                        if (audioTrack) audioTrack.enabled = false;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                        mediaState.audioEnabled = false;
                        mediaState.videoEnabled = false;
                        
                        updateMediaUI();
                        mainPlaceholder.style.display = 'flex';
                        mainVideo.style.display = 'none';
                    };
                }

                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∏–¥–µ–æ –¥–ª—è –º–∏–Ω–∏–∞—Ç—é—Ä—ã
                if (localVideoThumbnail) {
                    localVideoThumbnail.srcObject = localStream;
                }

                showNotification('–ö–∞–º–µ—Ä–∞ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω—ã');

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
                
                // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
                createMediaPermissionButton();
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∞—É–¥–∏–æ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–µ—á–∏
        function setupAudioAnalysis() {
            if (!localStream) return;
            
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(localStream);
                source.connect(analyser);
                analyser.fftSize = 256;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–µ—á–∏
                speakingCheckInterval = setInterval(checkSpeakingActivity, 100);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ –∞—É–¥–∏–æ:', error);
            }
        }

         // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–µ—á–∏
        function checkSpeakingActivity() {
            if (!analyser || !mediaState.audioEnabled) {
                document.getElementById('list-item-local').classList.remove('speaking');
                document.getElementById('participant-local').classList.remove('speaking');
                return;
            }
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            
            // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å –≥—Ä–æ–º–∫–æ—Å—Ç–∏
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const average = sum / dataArray.length;
            
            // –ü–æ—Ä–æ–≥ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–µ—á–∏
            const speakingThreshold = 30;
            const isSpeaking = average > speakingThreshold;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const localListItem = document.getElementById('list-item-local');
            const localParticipantCard = document.getElementById('participant-local');
            if (isSpeaking) {
                localListItem.classList.add('speaking');
                localParticipantCard.classList.add('speaking');
            } else {
                localListItem.classList.remove('speaking');
                localParticipantCard.classList.remove('speaking');
            }
        }

        // –ï–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–¥–∏–∞
        function updateMediaUI() {
            console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –º–µ–¥–∏–∞:', mediaState);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏ –Ω–∞ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            const toggleAudioIcon = document.getElementById('toggleAudioIcon');
            const toggleVideoIcon = document.getElementById('toggleVideoIcon');
            const toggleAudioBtn = document.getElementById('toggleAudio');
            const toggleVideoBtn = document.getElementById('toggleVideo');
            
            if (toggleAudioIcon && toggleAudioBtn) {
                toggleAudioIcon.src = mediaState.audioEnabled ? 
                    "{{ url_for('static', filename='images/mic-on.png') }}" : 
                    "{{ url_for('static', filename='images/mic-off.png') }}";
                
                if (mediaState.audioEnabled) {
                    toggleAudioBtn.classList.remove('muted');
                } else {
                    toggleAudioBtn.classList.add('muted');
                }
            }
            
            if (toggleVideoIcon && toggleVideoBtn) {
                toggleVideoIcon.src = mediaState.videoEnabled ? 
                    "{{ url_for('static', filename='images/camera-on.png') }}" : 
                    "{{ url_for('static', filename='images/camera-off.png') }}";
                
                if (mediaState.videoEnabled) {
                    toggleVideoBtn.classList.remove('muted');
                } else {
                    toggleVideoBtn.classList.add('muted');
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏
            const localAudioStatus = document.getElementById('localAudioStatus');
            const localVideoStatus = document.getElementById('localVideoStatus');
            
            if (localAudioStatus) {
                localAudioStatus.src = mediaState.audioEnabled ? 
                    "{{ url_for('static', filename='images/mic-on.png') }}" : 
                    "{{ url_for('static', filename='images/mic-off.png') }}";
                localAudioStatus.classList.toggle('muted', !mediaState.audioEnabled);
            }

            if (localVideoStatus) {
                localVideoStatus.src = mediaState.videoEnabled ? 
                    "{{ url_for('static', filename='images/camera-on.png') }}" : 
                    "{{ url_for('static', filename='images/camera-off.png') }}";
                localVideoStatus.classList.toggle('muted', !mediaState.videoEnabled);
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –≤ —Å–ø–∏—Å–∫–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            const listAudioStatus = document.getElementById('listAudioStatus');
            const listVideoStatus = document.getElementById('listVideoStatus');
            
            if (listAudioStatus) {
                listAudioStatus.src = mediaState.audioEnabled ? 
                    "{{ url_for('static', filename='images/mic-on.png') }}" : 
                    "{{ url_for('static', filename='images/mic-off.png') }}";
            }

            if (listVideoStatus) {
                listVideoStatus.src = mediaState.videoEnabled ? 
                    "{{ url_for('static', filename='images/camera-on.png') }}" : 
                    "{{ url_for('static', filename='images/camera-off.png') }}";
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–µ–æ –≤ –º–∏–Ω–∏–∞—Ç—é—Ä–µ (–ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å) - –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
            const localVideoThumbnail = document.getElementById('localVideoThumbnail');
            const localAvatar = document.querySelector('#participant-local .participant-avatar');
            
            if (localVideoThumbnail && localAvatar) {
                if (mediaState.videoEnabled) {
                    localVideoThumbnail.style.display = 'block';
                    localAvatar.style.display = 'none';
                } else {
                    localVideoThumbnail.style.display = 'none';
                    localAvatar.style.display = 'flex';
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–∞–≤–Ω–æ–µ –≤–∏–¥–µ–æ –≤ —Ü–µ–Ω—Ç—Ä–µ
            updateMainVideoDisplay();
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –¥–æ—Å–∫–∏
        function toggleWhiteboard() {
            mediaState.whiteboardActive = !mediaState.whiteboardActive;
            updateMainVideoDisplay();
            
            const whiteboardBtn = document.getElementById('toggleWhiteboardBtn');
            if (whiteboardBtn) {
                if (mediaState.whiteboardActive) {
                    whiteboardBtn.classList.add('active');
                    showNotification('–î–æ—Å–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞');
                } else {
                    whiteboardBtn.classList.remove('active');
                    showNotification('–î–æ—Å–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞');
                }
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ –≤–∏–¥–µ–æ –¥–ª—è —É—á–µ—Ç–∞ –¥–æ—Å–∫–∏
        function updateMainVideoDisplay() {
            const mainVideo = document.getElementById('mainVideo');
            const screenShareVideo = document.getElementById('screenShareVideo');
            const mainPlaceholder = document.getElementById('mainVideoPlaceholder');
            const whiteboardFrame = document.getElementById('whiteboardFrame');
            
            if (mediaState.whiteboardActive) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å–∫—É –≤ —Ü–µ–Ω—Ç—Ä–µ
                mainPlaceholder.style.display = 'none';
                mainVideo.style.display = 'none';
                screenShareVideo.style.display = 'none';
                if (whiteboardFrame) whiteboardFrame.style.display = 'block';
            } else if (mediaState.screenSharing) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é —ç–∫—Ä–∞–Ω–∞
                mainPlaceholder.style.display = 'none';
                mainVideo.style.display = 'none';
                screenShareVideo.style.display = 'block';
                if (whiteboardFrame) whiteboardFrame.style.display = 'none';
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É –∏–ª–∏ –∞–≤–∞—Ç–∞—Ä
                if (whiteboardFrame) whiteboardFrame.style.display = 'none';
                screenShareVideo.style.display = 'none';
                
                if (mediaState.videoEnabled) {
                    mainPlaceholder.style.display = 'none';
                    mainVideo.style.display = 'block';
                } else {
                    mainPlaceholder.style.display = 'flex';
                    mainVideo.style.display = 'none';
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞—É–¥–∏–æ
        function toggleAudio() {
            if (!localStream) return;
            
            const audioTracks = localStream.getAudioTracks();
            if (audioTracks.length > 0) {
                mediaState.audioEnabled = !mediaState.audioEnabled;
                audioTracks[0].enabled = mediaState.audioEnabled;
                updateMediaUI();
                showNotification(mediaState.audioEnabled ? '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω' : '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–µ–æ
        function toggleVideo() {
            if (!localStream) return;
            
            const videoTracks = localStream.getVideoTracks();
            if (videoTracks.length > 0) {
                mediaState.videoEnabled = !mediaState.videoEnabled;
                videoTracks[0].enabled = mediaState.videoEnabled;
                updateMediaUI();
                showNotification(mediaState.videoEnabled ? '–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞' : '–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞');
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ UI
        function setupUIHandlers() {
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —á–∞—Ç–∞/—Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            const toggleChatBtn = document.getElementById('toggleChatBtn');
            const chatSidebar = document.getElementById('chatSidebar');
            const participantsSidebar = document.getElementById('participantsListSidebar');

            if (toggleChatBtn) {
                toggleChatBtn.addEventListener('click', function() {
                    if (chatSidebar.style.display === 'flex') {
                        participantsSidebar.style.display = 'flex';
                        chatSidebar.style.display = 'none';
                        toggleChatBtn.classList.remove('active');
                    } else {
                        participantsSidebar.style.display = 'none';
                        chatSidebar.style.display = 'flex';
                        toggleChatBtn.classList.add('active');
                    }
                });
            }

            // –ú–∏–∫—Ä–æ—Ñ–æ–Ω - –ø—Ä—è–º–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
            const toggleAudioBtn = document.getElementById('toggleAudio');
            if (toggleAudioBtn) {
                toggleAudioBtn.addEventListener('click', toggleAudio);
            }

            // –ö–∞–º–µ—Ä–∞ - –ø—Ä—è–º–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
            const toggleVideoBtn = document.getElementById('toggleVideo');
            if (toggleVideoBtn) {
                toggleVideoBtn.addEventListener('click', toggleVideo);
            }

            // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞
            const toggleScreenBtn = document.getElementById('toggleScreen');
            if (toggleScreenBtn) {
                toggleScreenBtn.addEventListener('click', toggleScreenShare);
            }

            // –î–æ—Å–∫–∞
            const toggleWhiteboardBtn = document.getElementById('toggleWhiteboardBtn');
            if (toggleWhiteboardBtn) {
                toggleWhiteboardBtn.addEventListener('click', toggleWhiteboard);
            }

            // –í—ã—Ö–æ–¥ –∏–∑ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏
            const leaveCallBtn = document.getElementById('leaveCall');
            if (leaveCallBtn) {
                leaveCallBtn.addEventListener('click', function() {
                    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å –≤—Å—Ç—Ä–µ—á—É?')) {
                        stopAllMedia();
                        window.location.href = '/';
                    }
                });
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏
            const expandLeftPanelBtn = document.getElementById('expandLeftPanel');
            const leftPanel = document.getElementById('leftPanel');
            const centerPanel = document.getElementById('centerPanel');

            if (expandLeftPanelBtn && leftPanel) {
                expandLeftPanelBtn.addEventListener('click', function() {
                    leftPanel.classList.toggle('collapsed');
                    centerPanel.classList.toggle('expanded');
                });
            }
        }

        // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ (–ù–ï –≤–ª–∏—è–µ—Ç –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –∫–∞–º–µ—Ä—É)
        async function toggleScreenShare() {
            try {
                if (!mediaState.screenSharing) {
                    // –ó–∞–ø—É—Å–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
                    screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: true,
                        audio: false // –ù–µ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –∞—É–¥–∏–æ —Å —ç–∫—Ä–∞–Ω–∞
                    });
                    
                    const screenShareVideo = document.getElementById('screenShareVideo');
                    
                    if (screenShareVideo) {
                        screenShareVideo.srcObject = screenStream;
                    }
                    
                    // –í–ê–ñ–ù–û: –ù–ï –º–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∏ –∫–∞–º–µ—Ä—ã
                    mediaState.screenSharing = true;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –≤–∏–¥–µ–æ
                    updateMainVideoDisplay();
                    
                    document.getElementById('toggleScreen').classList.add('active');
                    showNotification('–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –Ω–∞—á–∞—Ç–∞');
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                    screenStream.getVideoTracks()[0].onended = () => {
                        stopScreenShare();
                    };
                    
                } else {
                    stopScreenShare();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞:', error);
                if (error.name === 'NotAllowedError') {
                    showNotification('–î–æ—Å—Ç—É–ø –∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
                } else {
                    showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é —ç–∫—Ä–∞–Ω–∞');
                }
            }
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
        function stopScreenShare() {
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }
            
            mediaState.screenSharing = false;
            const toggleScreenBtn = document.getElementById('toggleScreen');
            
            if (toggleScreenBtn) {
                toggleScreenBtn.classList.remove('active');
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –≤–∏–¥–µ–æ
            updateMainVideoDisplay();
            
            showNotification('–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–æ–≤
        function stopAllMedia() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
            }
            if (speakingCheckInterval) {
                clearInterval(speakingCheckInterval);
            }
            if (audioContext) {
                audioContext.close();
            }
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏
            mediaState.whiteboardActive = false;
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ layout
        function setupAdaptiveLayout() {
            function handleResize() {
                const width = window.innerWidth;
                const leftPanel = document.getElementById('leftPanel');
                const centerPanel = document.getElementById('centerPanel');
                const expandLeftPanelBtn = document.getElementById('expandLeftPanel');

                if (width <= 768) {
                    if (leftPanel) leftPanel.classList.add('collapsed');
                    if (centerPanel) centerPanel.classList.add('expanded');
                    if (expandLeftPanelBtn) expandLeftPanelBtn.style.display = 'flex';
                } else {
                    if (leftPanel) leftPanel.classList.remove('collapsed');
                    if (centerPanel) centerPanel.classList.remove('expanded');
                    if (expandLeftPanelBtn) expandLeftPanelBtn.style.display = 'none';
                }
            }

            window.addEventListener('resize', handleResize);
            handleResize();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        function updateParticipantCount() {
            const totalParticipants = 1;
            document.getElementById('participantCount').textContent = `üë• ${totalParticipants}`;
            document.getElementById('participantsCount').textContent = totalParticipants;
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–∞—Ç–æ–º
        function handleChatInputKeypress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (message) {
                addChatMessage('–í—ã', message, true);
                chatInput.value = '';
                
                // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket
                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', message);
            }
        }

        function addChatMessage(sender, text, isOwn = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = isOwn ? 'message own-message' : 'message remote-message';
            
            const now = new Date();
            const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                             now.getMinutes().toString().padStart(2, '0');
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">${sender}</span>
                    <span class="message-time">${timeString}</span>
                </div>
                <div class="message-text">${text}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'media-notification';
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(20px);
                padding: 12px 24px;
                border-radius: 25px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
                z-index: 1001;
                font-weight: 600;
                color: #333;
                animation: slideDown 0.3s ease;
                border: 1px solid rgba(255, 255, 255, 0.2);
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –º–µ–¥–∏–∞
        function createMediaPermissionButton() {
            const retryBtn = document.createElement('button');
            retryBtn.textContent = '–†–∞–∑—Ä–µ—à–∏—Ç—å –∫–∞–º–µ—Ä—É –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω';
            retryBtn.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #007bff;
                color: white;
                border: none;
                padding: 15px 30px;
                border-radius: 25px;
                font-size: 16px;
                cursor: pointer;
                z-index: 1001;
                box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
            `;
            
            retryBtn.addEventListener('click', function() {
                retryBtn.remove();
                initializeMedia();
            });
            
            document.body.appendChild(retryBtn);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', function() {
            stopAllMedia();
        });
    </script>
</body>
</html>