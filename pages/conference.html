<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è - Insight Room</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/conference.css') }}">
</head>
<body>
    <div class="animated-bg"></div>
    
    <header class="header">
        <div class="container">
            <div class="logo">
                <a href="../index.html" class="logo-link">Insight Room</a>
            </div>
            <nav class="nav">
                <div class="meeting-info">
                    <span id="meetingId">ID: –ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    <span id="participantCount">üë• 1</span>
                </div>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="conference-container">
            <div class="participants-grid" id="participantsGrid">
                <!-- –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -->
                <div class="participant-card local-user">
                    <div class="video-container">
                        <video id="localVideo" class="user-video" autoplay muted></video>
                        <div class="participant-info">
                            <span class="participant-name" id="localUserName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                            <div class="participant-status">
                                <div class="status-indicator" id="localAudioStatus"></div>
                                <div class="status-indicator" id="localVideoStatus"></div>
                            </div>
                        </div>
<<<<<<< Updated upstream
=======
                        {% endfor %}
                    {% endif %}
                </div>

                {% if not participants %}
                <div class="empty-state">
                    <p>–ù–µ—Ç –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
                </div>
                {% endif %}
            </div>

            <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å - –≥–ª–∞–≤–Ω–æ–µ –≤–∏–¥–µ–æ -->
            <div class="center-panel" id="centerPanel">
                <div class="main-video-container" id="mainVideoContainer">
                    <div class="video-placeholder active" id="mainVideoPlaceholder">
                        <div class="placeholder-content">
                            <div class="user-avatar large" id="mainUserAvatar">{{ user_name[:2]|upper if user_name else '–£–ß' }}</div>
                            <div class="user-name" id="mainUserName">{{ user_name or '–£—á–∞—Å—Ç–Ω–∏–∫' }}</div>
                        </div>
                    </div>
                    <video id="mainVideo" class="main-video" autoplay playsinline></video>
                    <video id="screenShareVideo" class="main-video" autoplay playsinline style="display: none;"></video>

                    <!-- –î–æ–±–∞–≤–ª—è–µ–º iframe –¥–ª—è Excalidraw —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é -->
                    <iframe 
                        id="whiteboardFrame" 
                        src="https://excalidraw.com/" 
                        style="display: none; width: 100%; height: 100%; border: none; border-radius: 8px;"
                        allow="clipboard-read; clipboard-write"
                        sandbox="allow-scripts allow-same-origin allow-popups allow-forms"
                        title="–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ—Å–∫–∞"
                    ></iframe>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - —á–∞—Ç –∏ —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
            <div class="right-panel">
                <!-- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
                <div class="sidebar" id="participantsListSidebar">
                    <div class="sidebar-header">
                        <h3 class="sidebar-title">–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (<span id="participantsCount">{{ participants_count if participants_count else 1 }}</span>)</h3>
                    </div>
                    <div class="participants-list" id="participantsList">
                        <!-- –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -->
                        <div class="participant-list-item local-user" id="list-item-local">
                            <div class="participant-info">
                                <div class="participant-details">
                                    <div class="participant-name">{{ user_name or '–í—ã' }}</div>
                                </div>
                                <div class="participant-controls">
                                    <img src="{{ url_for('static', filename='images/mic-off.png') }}" 
                                        alt="–ú–∏–∫—Ä–æ—Ñ–æ–Ω" class="status-icon muted" id="listAudioStatus">
                                    <img src="{{ url_for('static', filename='images/camera-off.png') }}" 
                                        alt="–ö–∞–º–µ—Ä–∞" class="status-icon muted" id="listVideoStatus">
                                </div>
                            </div>
                        </div>

                        <!-- –£–¥–∞–ª–µ–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –≤ —Å–ø–∏—Å–∫–µ -->
                        {% if participants %}
                            {% for participant in participants %}
                            <div class="participant-list-item remote-user" id="list-item-{{ participant.id }}">
                                <div class="participant-info">
                                    <div class="participant-details">
                                        <div class="participant-name">{{ participant.name or '–£—á–∞—Å—Ç–Ω–∏–∫' }}</div>
                                    </div>
                                    <div class="participant-controls">
                                        <img src="{{ url_for('static', filename='images/mic-off.png') }}" 
                                            alt="–ú–∏–∫—Ä–æ—Ñ–æ–Ω" class="status-icon muted" id="list-audio-{{ participant.id }}">
                                        <img src="{{ url_for('static', filename='images/camera-off.png') }}" 
                                            alt="–ö–∞–º–µ—Ä–∞" class="status-icon muted" id="list-video-{{ participant.id }}">
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>

                    {% if not participants %}
                    <div class="empty-state">
                        <p>–ù–µ—Ç –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
                    </div>
                    {% endif %}
                </div>

                <!-- –ß–∞—Ç (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                <div class="sidebar" id="chatSidebar" style="display: none;">
                    <div class="sidebar-header">
                        <h3 class="sidebar-title">–ß–∞—Ç –≤—Å—Ç—Ä–µ—á–∏</h3>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                         {% if chat_messages %}
                            {% for message in chat_messages %}
                            <div class="message {% if message.is_own %}own-message{% else %}remote-message{% endif %}">
                                <div class="message-header">
                                    <span class="message-sender">{{ message.sender }}</span>
                                    <span class="message-time">{{ message.time }}</span>
                                </div>
                                <div class="message-text">{{ message.text }}</div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state">
                                <p>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                            </div>
                        {% endif %}
                    </div>
                    <div class="chat-input-container">
                        <textarea class="chat-input" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                            onkeypress="handleChatInputKeypress(event)" 
                            rows="1"></textarea>
                        <button class="send-btn" id="sendMessage" onclick="sendChatMessage()">
                            <img src="{{ url_for('static', filename='images/send-message-icon.png') }}" alt="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
                        </button>
>>>>>>> Stashed changes
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="control-panel">
            <button class="control-btn" id="toggleAudio" title="–ú–∏–∫—Ä–æ—Ñ–æ–Ω">üé§</button>
            <button class="control-btn" id="toggleVideo" title="–ö–∞–º–µ—Ä–∞">üìπ</button>
            <button class="control-btn" id="toggleScreen" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —ç–∫—Ä–∞–Ω–æ–º">üñ•Ô∏è</button>
            <button class="control-btn danger" id="leaveCall" title="–ü–æ–∫–∏–Ω—É—Ç—å –≤—Å—Ç—Ä–µ—á—É">üìû</button>
        </div>
    </main>

<<<<<<< Updated upstream
    <script src="{{ url_for('static', filename='js/conference.js') }}"></script>
=======
    <!-- SocketIO –∫–ª–∏–µ–Ω—Ç -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>

    <!-- –ï–¥–∏–Ω—ã–π —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç —Å WebRTC -->
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å —á–µ—Ç–∫–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
        let localStream = null;
        let screenStream = null;
        let meetingStartTime = Date.now();
        let audioContext = null;
        let analyser = null;
        let speakingCheckInterval = null;
        
        // WebRTC –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let peerConnections = {};
        let socket = null;
        let roomUrl = null;
        let userName = '';
        let candidateQueue = {};
        let yourSocketId = null;
        let remoteStreams = {};
        let remoteIntervals = {};
        
        // –°–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–¥–∏–∞
        let mediaState = {
            audioEnabled: false,
            videoEnabled: false,
            screenSharing: false,
            whiteboardActive: false
        };

        /*// –¢–∞–π–º–µ—Ä –≤—Å—Ç—Ä–µ—á–∏
        function updateMeetingTimer() {
            const now = Date.now();
            const diff = now - meetingStartTime;
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            
            const timerElement = document.getElementById('meetingTimer');
            if (timerElement) {
                timerElement.textContent = '‚è∞ ' + hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
            }
        }
        
        setInterval(updateMeetingTimer, 1000);*/

        // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebRTC
            initWebRTC();
            
            // –°—Ä–∞–∑—É —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∫—Ä–∞—Å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            forceRedButtons();
            // –£–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –º–µ–¥–∏–∞
            // initializeMedia();
            setupUIHandlers();
            setupAdaptiveLayout();
            updateParticipantCount();
            // –£–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∞–Ω–∞–ª–∏–∑–∞ –∞—É–¥–∏–æ
            // setupAudioAnalysis();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebRTC
        function initWebRTC() {
            const pathParts = window.location.pathname.split('/');
            roomUrl = pathParts[pathParts.length - 1];
            userName = document.body.getAttribute('data-user-name') || '–£—á–∞—Å—Ç–Ω–∏–∫';
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Socket.IO
            socket = io();
            
            socket.on('connect', () => {
                console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–µ—Ä–≤–µ—Ä—É —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞');
                socket.emit('join-room', {
                    roomUrl: roomUrl,
                    userName: userName
                });
            });

            socket.on('connected', (data) => {
                console.log('–°–æ–∫–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω:', data);
            });

            socket.on('room-users', (data) => {
                console.log('–¢–µ–∫—É—â–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏:', data.users);
                yourSocketId = data.yourId;
                
                data.users.forEach(user => {
                    if (user.id !== yourSocketId) {
                        console.log('–°–æ–∑–¥–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–º:', user.name);
                        createPeerConnection(user.id, user.name);
                    }
                });
            });

            socket.on('user-joined', (data) => {
                console.log('–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è:', data);
                createPeerConnection(data.userId, data.userName);
                updateParticipantCount();
                showNotification(`${data.userName} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –≤—Å—Ç—Ä–µ—á–µ`);
            });

            socket.on('user-left', (data) => {
                console.log('–£—á–∞—Å—Ç–Ω–∏–∫ –≤—ã—à–µ–ª:', data);
                removePeerConnection(data.userId);
                updateParticipantCount();
                showNotification(`${data.userName} –ø–æ–∫–∏–Ω—É–ª –≤—Å—Ç—Ä–µ—á—É`);
            });

            socket.on('webrtc-offer', async (data) => {
                console.log('–ü–æ–ª—É—á–µ–Ω OFFER –æ—Ç:', data.from);
                await handleOffer(data.offer, data.from);
            });

            socket.on('webrtc-answer', async (data) => {
                console.log('–ü–æ–ª—É—á–µ–Ω ANSWER –æ—Ç:', data.from);
                await handleAnswer(data.answer, data.from);
            });

            socket.on('ice-candidate', async (data) => {
                console.log('–ü–æ–ª—É—á–µ–Ω ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –æ—Ç:', data.from);
                await handleIceCandidate(data.candidate, data.from);
            });

            socket.on('error', (data) => {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∫–µ—Ç–∞:', data);
                showError(data.message);
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ PeerConnection
        function createPeerConnection(userId, userName) {
            if (peerConnections[userId]) {
                console.log('PeerConnection —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –¥–ª—è:', userId);
                return peerConnections[userId];
            }

            console.log('–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ PeerConnection –¥–ª—è:', userName, '(' + userId + ')');

            const peerConnection = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –µ—Å–ª–∏ –æ–Ω —É–∂–µ —Å–æ–∑–¥–∞–Ω
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                console.log('–õ–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ PeerConnection');
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π WebRTC
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–ª—è:', userId);
                    socket.emit('ice-candidate', {
                        to: userId,
                        candidate: event.candidate
                    });
                }
            };

            peerConnection.ontrack = (event) => {
                console.log('–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫ –æ—Ç:', userName);
                
                if (event.streams && event.streams[0]) {
                    remoteStreams[userId] = event.streams[0];
                    addRemoteVideo(userId, userName, event.streams[0]);
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    startRemoteStatusMonitoring(userId, event.streams[0]);
                }
            };

            peerConnection.onconnectionstatechange = () => {
                console.log(`–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å ${userName}:`, peerConnection.connectionState);
                
                if (peerConnection.connectionState === 'connected') {
                    console.log(`P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å ${userName}`);
                    const participantElement = document.getElementById(`participant-${userId}`);
                    if (participantElement) {
                        participantElement.classList.add('speaking');
                    }
                } else if (peerConnection.connectionState === 'disconnected' || 
                           peerConnection.connectionState === 'failed') {
                    const participantElement = document.getElementById(`participant-${userId}`);
                    if (participantElement) {
                        participantElement.classList.remove('speaking');
                    }
                }
            };

            peerConnections[userId] = peerConnection;
            candidateQueue[userId] = [];
            
            console.log('PeerConnection —Å–æ–∑–¥–∞–Ω, —Å–æ–∑–¥–∞–µ–º OFFER –¥–ª—è:', userId);
            setTimeout(() => createOffer(userId), 500);
            
            return peerConnection;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ offer
        async function createOffer(userId) {
            try {
                const peerConnection = peerConnections[userId];
                if (!peerConnection) {
                    console.error('PeerConnection –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ offer –¥–ª—è:', userId);
                    return;
                }
                
                console.log('–°–æ–∑–¥–∞–µ–º OFFER –¥–ª—è:', userId);
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                console.log('OFFER —Å–æ–∑–¥–∞–Ω, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ —Å–æ–∫–µ—Ç:', userId);
                socket.emit('webrtc-offer', {
                    to: userId,
                    offer: offer
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer:', error);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ offer
        async function handleOffer(offer, fromUserId) {
            console.log('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º OFFER –æ—Ç:', fromUserId);
            
            let peerConnection = peerConnections[fromUserId];
            if (!peerConnection) {
                console.log('PeerConnection –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –¥–ª—è:', fromUserId);
                peerConnection = createPeerConnection(fromUserId, '–£—á–∞—Å—Ç–Ω–∏–∫');
            }

            try {
                await peerConnection.setRemoteDescription(offer);
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                socket.emit('webrtc-answer', {
                    to: fromUserId,
                    answer: answer
                });
                
                processQueuedCandidates(fromUserId);
                
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ offer:", error);
            } 
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ answer
        async function handleAnswer(answer, fromUserId) {
            console.log('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º ANSWER –æ—Ç:', fromUserId);
            
            try {
                const peerConnection = peerConnections[fromUserId];
                if (peerConnection) {
                    await peerConnection.setRemoteDescription(answer);
                    processQueuedCandidates(fromUserId);
                } else {
                    console.error('PeerConnection –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è answer –æ—Ç:', fromUserId);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ answer:', error);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
        async function handleIceCandidate(candidate, fromUserId) {
            console.log('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –æ—Ç:', fromUserId);
            
            const pc = peerConnections[fromUserId];
            if (!pc) {
                console.error('PeerConnection –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –æ—Ç:', fromUserId);
                return;
            }

            try {
                if (pc.remoteDescription && pc.remoteDescription.type) {
                    await pc.addIceCandidate(candidate);
                    console.log('ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è:', fromUserId);
                } else {
                    if (!candidateQueue[fromUserId]) {
                        candidateQueue[fromUserId] = [];
                    }
                    candidateQueue[fromUserId].push(candidate);
                    console.log('ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±—É—Ñ–µ—Ä –¥–ª—è:', fromUserId);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:', error);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
        async function processQueuedCandidates(userId) {
            const queue = candidateQueue[userId];
            if (queue && queue.length > 0) {
                console.log(`–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º ${queue.length} –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –∏–∑ –±—É—Ñ–µ—Ä–∞ –¥–ª—è:`, userId);
                
                for (const candidate of queue) {
                    try {
                        await peerConnections[userId].addIceCandidate(candidate);
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:', error);
                    }
                }
                candidateQueue[userId] = [];
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ
        function addRemoteVideo(userId, userName, stream) {
            console.log('–î–æ–±–∞–≤–ª—è–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ –¥–ª—è:', userName);
            
            const participantsGrid = document.getElementById('videoParticipantsList');
            if (!participantsGrid) {
                console.error('–≠–ª–µ–º–µ–Ω—Ç videoParticipantsList –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }
            
            // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
            const existingElement = document.getElementById(`participant-${userId}`);
            if (existingElement) {
                existingElement.remove();
            }
            
            const initials = userName ? userName.slice(0, 2).toUpperCase() : '–£–ß';
            
            const participantCard = document.createElement('div');
            participantCard.className = 'video-participant-card remote-user';
            participantCard.id = `participant-${userId}`;
            
            participantCard.innerHTML = `
                <div class="video-placeholder">
                    <div class="participant-avatar">${initials}</div>
                    <video class="remote-video" autoplay playsinline style="display: none;"></video>
                </div>
                <div class="participant-name">${userName}</div>
                <div class="participant-status">
                    <img src="{{ url_for('static', filename='images/mic-off.png') }}" alt="–ú–∏–∫—Ä–æ—Ñ–æ–Ω" class="status-icon muted" id="audio-${userId}">
                    <img src="{{ url_for('static', filename='images/camera-off.png') }}" alt="–ö–∞–º–µ—Ä–∞" class="status-icon muted" id="video-${userId}">
                </div>
            `;
            
            const videoElement = participantCard.querySelector('.remote-video');
            const placeholder = participantCard.querySelector('.video-placeholder');
            const avatar = participantCard.querySelector('.participant-avatar');
            
            console.log('–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º srcObject –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ');
            videoElement.srcObject = stream;
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤–∏–¥–µ–æ
            videoElement.onloadedmetadata = () => {
                console.log('–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–ª—è:', userName);
                videoElement.play().catch(e => {
                    console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', e);
                });
            };
            
            videoElement.onloadeddata = () => {
                console.log('–î–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–ª—è:', userName);
                placeholder.style.display = 'none';
                videoElement.style.display = 'block';
            };
            
            videoElement.oncanplay = () => {
                console.log('–£–¥–∞–ª–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ –º–æ–∂–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è –¥–ª—è:', userName);
                placeholder.style.display = 'none';
                videoElement.style.display = 'block';
            };
            
            videoElement.onerror = (e) => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ –¥–ª—è:', userName, e);
                placeholder.style.display = 'flex';
                avatar.style.display = 'flex';
            };
            
            participantsGrid.appendChild(participantCard);
            updateParticipantCount();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å–ø—Ä–∞–≤–∞
            addToParticipantsList(userId, userName);
            
            console.log('–£–¥–∞–ª–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ DOM –¥–ª—è:', userName);
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å–ø—Ä–∞–≤–∞
        function addToParticipantsList(userId, userName) {
            const participantsList = document.getElementById('participantsList');
            if (!participantsList) return;
            
            const existingItem = document.getElementById(`list-item-${userId}`);
            if (existingItem) {
                existingItem.remove();
            }
            
            const listItem = document.createElement('div');
            listItem.className = 'participant-list-item remote-user';
            listItem.id = `list-item-${userId}`;
            
            // –í –ø—Ä–∞–≤–æ–º –±–ª–æ–∫–µ –¢–û–õ–¨–ö–û –∏–∫–æ–Ω–∫–∏, –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è
            listItem.innerHTML = `
                <div class="participant-info">
                    <div class="participant-details">
                        <div class="participant-name">${userName}</div>
                    </div>
                    <div class="participant-controls">
                        <img src="{{ url_for('static', filename='images/mic-off.png') }}" 
                            alt="–ú–∏–∫—Ä–æ—Ñ–æ–Ω" class="status-icon" id="list-audio-${userId}">
                        <img src="{{ url_for('static', filename='images/camera-off.png') }}" 
                            alt="–ö–∞–º–µ—Ä–∞" class="status-icon" id="list-video-${userId}">
                    </div>
                </div>
            `;
            
            participantsList.appendChild(listItem);
        }

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        function startRemoteStatusMonitoring(userId, stream) {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –±—ã–ª
            if (remoteIntervals[userId]) {
                clearInterval(remoteIntervals[userId]);
            }

            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
            remoteIntervals[userId] = setInterval(() => {
                updateRemoteStatusIndicators(userId, stream);
            }, 1000);

            // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            updateRemoteStatusIndicators(userId, stream);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —Å—Ç–∞—Ç—É—Å–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        function updateRemoteStatusIndicators(userId, stream) {
            const audioTracks = stream.getAudioTracks();
            const videoTracks = stream.getVideoTracks();
            
            const audioEnabled = audioTracks.length > 0 && audioTracks[0].enabled;
            const videoEnabled = videoTracks.length > 0 && videoTracks[0].enabled;
            
            // 1. –õ–ï–í–´–ô –ë–õ–û–ö "–£—á–∞—Å—Ç–Ω–∏–∫–∏" - —Å –∑–µ–ª–µ–Ω–æ–π –æ–±–≤–æ–¥–∫–æ–π –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            const audioIndicator = document.getElementById(`audio-${userId}`);
            const videoIndicator = document.getElementById(`video-${userId}`);
            const participantElement = document.getElementById(`participant-${userId}`);
            
            if (audioIndicator) {
                const audioSrc = audioEnabled ? 
                    "{{ url_for('static', filename='images/mic-on.png') }}" : 
                    "{{ url_for('static', filename='images/mic-off.png') }}";
                if (audioIndicator.src !== audioSrc) {
                    audioIndicator.src = audioSrc;
                }
                audioIndicator.classList.toggle('muted', !audioEnabled);
            }
            
            if (videoIndicator) {
                const videoSrc = videoEnabled ? 
                    "{{ url_for('static', filename='images/camera-on.png') }}" : 
                    "{{ url_for('static', filename='images/camera-off.png') }}";
                if (videoIndicator.src !== videoSrc) {
                    videoIndicator.src = videoSrc;
                }
                videoIndicator.classList.toggle('muted', !videoEnabled);
            }
            
            // 2. –ü–†–ê–í–´–ô –ë–õ–û–ö "–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤" - –¢–û–õ–¨–ö–û –∏–∫–æ–Ω–∫–∏, –ë–ï–ó –∑–µ–ª–µ–Ω–æ–π –æ–±–≤–æ–¥–∫–∏
            const listAudioIndicator = document.getElementById(`list-audio-${userId}`);
            const listVideoIndicator = document.getElementById(`list-video-${userId}`);
            const listItemElement = document.getElementById(`list-item-${userId}`);
            
            if (listAudioIndicator) {
                const listAudioSrc = audioEnabled ? 
                    "{{ url_for('static', filename='images/mic-on.png') }}" : 
                    "{{ url_for('static', filename='images/mic-off.png') }}";
                if (listAudioIndicator.src !== listAudioSrc) {
                    listAudioIndicator.src = listAudioSrc;
                }
                // –í –ø—Ä–∞–≤–æ–º –±–ª–æ–∫–µ –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å 'muted' –¥–ª—è –∏–∫–æ–Ω–æ–∫
                // listAudioIndicator.classList.toggle('muted', !audioEnabled);
            }
            
            if (listVideoIndicator) {
                const listVideoSrc = videoEnabled ? 
                    "{{ url_for('static', filename='images/camera-on.png') }}" : 
                    "{{ url_for('static', filename='images/camera-off.png') }}";
                if (listVideoIndicator.src !== listVideoSrc) {
                    listVideoIndicator.src = listVideoSrc;
                }
                // –í –ø—Ä–∞–≤–æ–º –±–ª–æ–∫–µ –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å 'muted' –¥–ª—è –∏–∫–æ–Ω–æ–∫
                // listVideoIndicator.classList.toggle('muted', !videoEnabled);
            }
            
            // 3. –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å 'speaking' –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –ø—Ä–∞–≤–æ–º –±–ª–æ–∫–µ (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω)
            if (listItemElement) {
                listItemElement.classList.remove('speaking');
            }
            
            // 4. –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–∏–¥–µ–æ –≤ –ª–µ–≤–æ–º –±–ª–æ–∫–µ
            if (participantElement) {
                const videoElement = participantElement.querySelector('.remote-video');
                const placeholder = participantElement.querySelector('.video-placeholder');
                const avatar = participantElement.querySelector('.participant-avatar');
                
                if (videoElement && placeholder && avatar) {
                    if (videoEnabled) {
                        placeholder.style.display = 'none';
                        videoElement.style.display = 'block';
                        avatar.style.display = 'none';
                    } else {
                        placeholder.style.display = 'flex';
                        videoElement.style.display = 'none';
                        avatar.style.display = 'flex';
                    }
                }
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ PeerConnection
        function removePeerConnection(userId) {
            console.log('–£–¥–∞–ª–µ–Ω–∏–µ PeerConnection –¥–ª—è:', userId);
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
            if (remoteIntervals[userId]) {
                clearInterval(remoteIntervals[userId]);
                delete remoteIntervals[userId];
            }
            
            if (peerConnections[userId]) {
                peerConnections[userId].close();
                delete peerConnections[userId];
            }
            
            if (candidateQueue[userId]) {
                delete candidateQueue[userId];
            }
            
            if (remoteStreams[userId]) {
                delete remoteStreams[userId];
            }
            
            // –£–¥–∞–ª—è–µ–º –∏–∑ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏
            const participantElement = document.getElementById(`participant-${userId}`);
            if (participantElement) {
                participantElement.remove();
            }
            
            // –£–¥–∞–ª—è–µ–º –∏–∑ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            const listItem = document.getElementById(`list-item-${userId}`);
            if (listItem) {
                listItem.remove();
            }
        }

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∫—Ä–∞—Å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        function forceRedButtons() {
            const toggleAudioBtn = document.getElementById('toggleAudio');
            const toggleVideoBtn = document.getElementById('toggleVideo');
            
            if (toggleAudioBtn) {
                toggleAudioBtn.classList.add('muted');
            }
            if (toggleVideoBtn) {
                toggleVideoBtn.classList.add('muted');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–¥–∏–∞
       async function initializeMedia(requestAudio = false, requestVideo = false) {
            try {
                console.log('–ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –Ω–∞ –º–µ–¥–∏–∞:', { requestAudio, requestVideo });
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç constraints –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–æ–≤
                const constraints = {};
                
                if (requestVideo) {
                    constraints.video = {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    };
                } else {
                    constraints.video = false;
                }
                
                if (requestAudio) {
                    constraints.audio = {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                    };
                } else {
                    constraints.audio = false;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫ —Ç–æ–ª—å–∫–æ —Å –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–º–∏ —Ç—Ä–µ–∫–∞–º–∏
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–±—ä–µ–¥–∏–Ω—è–µ–º —Ç—Ä–µ–∫–∏
                if (localStream) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ç—Ä–µ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è
                    const oldTracks = {};
                    localStream.getTracks().forEach(track => {
                        oldTracks[track.kind] = track;
                    });
                    
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è
                    const newStream = new MediaStream();
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ç—Ä–µ–∫–∏ –∏–∑ –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
                    stream.getTracks().forEach(track => {
                        newStream.addTrack(track);
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                        if (track.kind === 'audio') {
                            mediaState.audioEnabled = track.enabled;
                        } else if (track.kind === 'video') {
                            mediaState.videoEnabled = track.enabled;
                            
                            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –≤–∏–¥–µ–æ –µ—Å–ª–∏ —ç—Ç–æ –≤–∏–¥–µ–æ
                            if (requestVideo) {
                                const mainVideo = document.getElementById('mainVideo');
                                if (mainVideo) {
                                    mainVideo.srcObject = null;
                                    setTimeout(() => {
                                        mainVideo.srcObject = newStream;
                                    }, 100);
                                }
                                
                                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—É –≤–∏–¥–µ–æ
                                const localVideoThumbnail = document.getElementById('localVideoThumbnail');
                                if (localVideoThumbnail) {
                                    localVideoThumbnail.srcObject = null;
                                    setTimeout(() => {
                                        localVideoThumbnail.srcObject = newStream;
                                    }, 100);
                                }
                            }
                        }
                    });
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ç—Ä–µ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ –∑–∞–º–µ–Ω–µ–Ω—ã
                    if (!requestAudio && oldTracks.audio) {
                        newStream.addTrack(oldTracks.audio);
                    }
                    if (!requestVideo && oldTracks.video) {
                        newStream.addTrack(oldTracks.video);
                    }
                    
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ç—Ä–µ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∑–∞–º–µ–Ω–µ–Ω—ã
                    localStream.getTracks().forEach(track => {
                        if ((track.kind === 'audio' && requestAudio) || 
                            (track.kind === 'video' && requestVideo)) {
                            track.stop();
                        }
                    });
                    
                    localStream = newStream;
                } else {
                    // –ü–µ—Ä–≤—ã–π —Ä–∞–∑ —Å–æ–∑–¥–∞–µ–º –ø–æ—Ç–æ–∫
                    localStream = stream;
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    const audioTrack = stream.getAudioTracks()[0];
                    const videoTrack = stream.getVideoTracks()[0];
                    
                    if (audioTrack) {
                        mediaState.audioEnabled = audioTrack.enabled;
                    }
                    if (videoTrack) {
                        mediaState.videoEnabled = videoTrack.enabled;
                        
                        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –≤–∏–¥–µ–æ
                        const mainVideo = document.getElementById('mainVideo');
                        if (mainVideo && requestVideo) {
                            mainVideo.srcObject = localStream;
                        }
                        
                        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—É –≤–∏–¥–µ–æ
                        const localVideoThumbnail = document.getElementById('localVideoThumbnail');
                        if (localVideoThumbnail && requestVideo) {
                            localVideoThumbnail.srcObject = localStream;
                        }
                    }
                }

                console.log('–ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω:', localStream);

                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ PeerConnections —Å –Ω–æ–≤—ã–º–∏ —Ç—Ä–µ–∫–∞–º–∏
                Object.keys(peerConnections).forEach(userId => {
                    const peerConnection = peerConnections[userId];
                    if (peerConnection) {
                        // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∏ –∏–ª–∏ –≤—Å–µ –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π —Ä–∞–∑
                        peerConnection.getSenders().forEach(sender => {
                            if (!localStream || 
                                (sender.track && 
                                ((sender.track.kind === 'audio' && requestAudio) || 
                                (sender.track.kind === 'video' && requestVideo)))) {
                                peerConnection.removeTrack(sender);
                            }
                        });
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ç—Ä–µ–∫–∏ –∏–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
                        localStream.getTracks().forEach(track => {
                            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤—ã–π —Ç—Ä–µ–∫ –∏–ª–∏ –∑–∞–º–µ–Ω—è–µ–º—ã–π
                            if ((track.kind === 'audio' && requestAudio) || 
                                (track.kind === 'video' && requestVideo) ||
                                !peerConnections[userId]) {
                                peerConnection.addTrack(track, localStream);
                            }
                        });
                    }
                });

                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–Ω–∞–ª–∏–∑ –∞—É–¥–∏–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω –º–∏–∫—Ä–æ—Ñ–æ–Ω
                if (mediaState.audioEnabled) {
                    setupAudioAnalysis();
                }
                
                updateMediaUI(); // –û–±–Ω–æ–≤–ª—è–µ–º –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–µ–¥–∏–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.');

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞:', error);
                // –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –Ω–µ—É–¥–∞—á–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
                if (requestAudio) {
                    mediaState.audioEnabled = false;
                }
                if (requestVideo) {
                    mediaState.videoEnabled = false;
                }
                updateMediaUI();
                
                if (error.name === 'NotAllowedError') {
                    showNotification('–î–æ—Å—Ç—É–ø –∫ –º–µ–¥–∏–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
                } else {
                    showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–µ–¥–∏–∞');
                }
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∞—É–¥–∏–æ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–µ—á–∏
        function setupAudioAnalysis() {
            if (!localStream || !mediaState.audioEnabled) {
                if (speakingCheckInterval) {
                    clearInterval(speakingCheckInterval);
                    speakingCheckInterval = null;
                }
                return;
            }
            
            try {
                // –ï—Å–ª–∏ –∞—É–¥–∏–æ–∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
                if (!audioContext || audioContext.state === 'closed') {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(localStream);
                source.connect(analyser);
                analyser.fftSize = 256;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–µ—á–∏
                if (speakingCheckInterval) {
                    clearInterval(speakingCheckInterval);
                }
                speakingCheckInterval = setInterval(checkSpeakingActivity, 100);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ –∞—É–¥–∏–æ:', error);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–µ—á–∏
        function checkSpeakingActivity() {
            if (!analyser || !mediaState.audioEnabled) {
                // –£–±–∏—Ä–∞–µ–º –∑–µ–ª–µ–Ω—É—é –æ–±–≤–æ–¥–∫—É –¢–û–õ–¨–ö–û –≤ –ª–µ–≤–æ–º –±–ª–æ–∫–µ
                document.getElementById('participant-local').classList.remove('speaking');
                // –í –ø—Ä–∞–≤–æ–º –±–ª–æ–∫–µ –ù–ò–ö–û–ì–î–ê –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º/—É–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å 'speaking'
                return;
            }
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const average = sum / dataArray.length;
            
            const speakingThreshold = 30;
            const isSpeaking = average > speakingThreshold;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¢–û–õ–¨–ö–û –ª–µ–≤—ã–π –±–ª–æ–∫
            const localParticipantCard = document.getElementById('participant-local');
            if (isSpeaking) {
                localParticipantCard.classList.add('speaking');
            } else {
                localParticipantCard.classList.remove('speaking');
            }
            
            // –ü—Ä–∞–≤—ã–π –±–ª–æ–∫ "–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤" –ù–ï —Ç—Ä–æ–≥–∞–µ–º!
            // –ó–¥–µ—Å—å –ù–ò–ß–ï–ì–û –Ω–µ –¥–µ–ª–∞–µ–º —Å list-item-local
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–¥–∏–∞
        function updateMediaUI() {
            console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –º–µ–¥–∏–∞:', mediaState);
            
            // –ï—Å–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω - —É–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            if (!mediaState.audioEnabled) {
                document.getElementById('participant-local').classList.remove('speaking');
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏ –Ω–∞ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            const toggleAudioIcon = document.getElementById('toggleAudioIcon');
            const toggleVideoIcon = document.getElementById('toggleVideoIcon');
            const toggleAudioBtn = document.getElementById('toggleAudio');
            const toggleVideoBtn = document.getElementById('toggleVideo');
            
            if (toggleAudioIcon && toggleAudioBtn) {
                toggleAudioIcon.src = mediaState.audioEnabled ? 
                    "{{ url_for('static', filename='images/mic-on.png') }}" : 
                    "{{ url_for('static', filename='images/mic-off.png') }}";
                
                if (mediaState.audioEnabled) {
                    toggleAudioBtn.classList.remove('muted');
                } else {
                    toggleAudioBtn.classList.add('muted');
                }
            }
            
            if (toggleVideoIcon && toggleVideoBtn) {
                toggleVideoIcon.src = mediaState.videoEnabled ? 
                    "{{ url_for('static', filename='images/camera-on.png') }}" : 
                    "{{ url_for('static', filename='images/camera-off.png') }}";
                
                if (mediaState.videoEnabled) {
                    toggleVideoBtn.classList.remove('muted');
                } else {
                    toggleVideoBtn.classList.add('muted');
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–ª–µ–≤–∞ –≤–Ω–∏–∑—É
            const localAudioStatus = document.getElementById('localAudioStatus');
            const localVideoStatus = document.getElementById('localVideoStatus');
            
            if (localAudioStatus) {
                localAudioStatus.src = mediaState.audioEnabled ? 
                    "{{ url_for('static', filename='images/mic-on.png') }}" : 
                    "{{ url_for('static', filename='images/mic-off.png') }}";
                localAudioStatus.classList.toggle('muted', !mediaState.audioEnabled);
            }

            if (localVideoStatus) {
                localVideoStatus.src = mediaState.videoEnabled ? 
                    "{{ url_for('static', filename='images/camera-on.png') }}" : 
                    "{{ url_for('static', filename='images/camera-off.png') }}";
                localVideoStatus.classList.toggle('muted', !mediaState.videoEnabled);
            }
            
            // –û–ë–ù–û–í–õ–Ø–ï–ú –ò–ö–û–ù–ö–ò –í –°–ü–ò–°–ö–ï –£–ß–ê–°–¢–ù–ò–ö–û–í –°–ü–†–ê–í–ê
            const listAudioStatus = document.getElementById('listAudioStatus');
            const listVideoStatus = document.getElementById('listVideoStatus');
            
            if (listAudioStatus) {
                listAudioStatus.src = mediaState.audioEnabled ? 
                    "{{ url_for('static', filename='images/mic-on.png') }}" : 
                    "{{ url_for('static', filename='images/mic-off.png') }}";
            }
            
            if (listVideoStatus) {
                listVideoStatus.src = mediaState.videoEnabled ? 
                    "{{ url_for('static', filename='images/camera-on.png') }}" : 
                    "{{ url_for('static', filename='images/camera-off.png') }}";
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—É –ª–µ–≤–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è (–≤–∏–¥–µ–æ)
            const localVideoThumbnail = document.getElementById('localVideoThumbnail');
            const localAvatar = document.querySelector('#participant-local .participant-avatar');
            
            if (localVideoThumbnail && localAvatar) {
                if (mediaState.videoEnabled && localVideoThumbnail.srcObject) {
                    localVideoThumbnail.style.display = 'block';
                    localAvatar.style.display = 'none';
                } else {
                    localVideoThumbnail.style.display = 'none';
                    localAvatar.style.display = 'flex';
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–∞–≤–Ω–æ–µ –≤–∏–¥–µ–æ –≤ —Ü–µ–Ω—Ç—Ä–µ
            updateMainVideoDisplay();
        }

        // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –¥–æ—Å–∫—É –∏–∑ toggleWhiteboard()
        function toggleWhiteboard() {
            mediaState.whiteboardActive = !mediaState.whiteboardActive;
            updateMainVideoDisplay();
            
            const whiteboardBtn = document.getElementById('toggleWhiteboardBtn');
            if (whiteboardBtn) {
                if (mediaState.whiteboardActive) {
                    whiteboardBtn.classList.add('active');
                    showNotification('–î–æ—Å–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞');
                } else {
                    whiteboardBtn.classList.remove('active');
                    showNotification('–î–æ—Å–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞');
                }
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ –≤–∏–¥–µ–æ –¥–ª—è —É—á–µ—Ç–∞ –¥–æ—Å–∫–∏
        function updateMainVideoDisplay() {
            const mainVideo = document.getElementById('mainVideo');
            const screenShareVideo = document.getElementById('screenShareVideo');
            const mainPlaceholder = document.getElementById('mainVideoPlaceholder');
            const whiteboardFrame = document.getElementById('whiteboardFrame');
            
            if (mediaState.whiteboardActive) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å–∫—É –≤ —Ü–µ–Ω—Ç—Ä–µ
                mainPlaceholder.style.display = 'none';
                mainVideo.style.display = 'none';
                screenShareVideo.style.display = 'none';
                if (whiteboardFrame) whiteboardFrame.style.display = 'block';
            } else if (mediaState.screenSharing) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é —ç–∫—Ä–∞–Ω–∞
                mainPlaceholder.style.display = 'none';
                mainVideo.style.display = 'none';
                screenShareVideo.style.display = 'block';
                if (whiteboardFrame) whiteboardFrame.style.display = 'none';
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É –∏–ª–∏ –∞–≤–∞—Ç–∞—Ä
                if (whiteboardFrame) whiteboardFrame.style.display = 'none';
                screenShareVideo.style.display = 'none';
                
                if (mediaState.videoEnabled && mainVideo.srcObject) {
                    mainPlaceholder.style.display = 'none';
                    mainVideo.style.display = 'block';
                } else {
                    mainPlaceholder.style.display = 'flex';
                    mainVideo.style.display = 'none';
                }
            }
        }

        // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –¥–æ—Å–∫—É –∏–∑ toggleAudio()
        function toggleAudio() {
            // –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∞—É–¥–∏–æ
            if (!localStream) {
                initializeMedia(true, false);
                return;
            }
            
            const audioTracks = localStream.getAudioTracks();
            if (audioTracks.length > 0) {
                // –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç—Ä–µ–∫–∞
                mediaState.audioEnabled = !audioTracks[0].enabled;
                audioTracks[0].enabled = mediaState.audioEnabled;
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–Ω–∞–ª–∏–∑ –∞—É–¥–∏–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–∏–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω
                if (mediaState.audioEnabled) {
                    setupAudioAnalysis();
                } else if (speakingCheckInterval) {
                    clearInterval(speakingCheckInterval);
                    speakingCheckInterval = null;
                    // –ï—Å–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω - —É–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                    document.getElementById('list-item-local').classList.remove('speaking');
                    document.getElementById('participant-local').classList.remove('speaking');
                }
                
                updateMediaUI();
                showNotification(mediaState.audioEnabled ? '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á—ë–Ω' : '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω');
            } else {
                // –ï—Å–ª–∏ –∞—É–¥–∏–æ—Ç—Ä–µ–∫–∞ –Ω–µ—Ç, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –µ–≥–æ
                initializeMedia(true, false);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–µ–æ–∫–∞–Ω–∞–ª–∞
        function toggleVideo() {
            // –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–µ–æ
            if (!localStream) {
                initializeMedia(false, true);
                return;
            }
            
            const videoTracks = localStream.getVideoTracks();
            if (videoTracks.length > 0) {
                // –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç—Ä–µ–∫–∞
                mediaState.videoEnabled = !videoTracks[0].enabled;
                videoTracks[0].enabled = mediaState.videoEnabled;
                
                updateMediaUI();
                showNotification(mediaState.videoEnabled ? '–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞' : '–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞');
            } else {
                // –ï—Å–ª–∏ –≤–∏–¥–µ–æ—Ç—Ä–µ–∫–∞ –Ω–µ—Ç, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –µ–≥–æ
                initializeMedia(false, true);
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ UI
        function setupUIHandlers() {
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —á–∞—Ç–∞/—Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            const toggleChatBtn = document.getElementById('toggleChatBtn');
            const chatSidebar = document.getElementById('chatSidebar');
            const participantsSidebar = document.getElementById('participantsListSidebar');

            if (toggleChatBtn) {
                toggleChatBtn.addEventListener('click', function() {
                    if (chatSidebar.style.display === 'flex') {
                        participantsSidebar.style.display = 'flex';
                        chatSidebar.style.display = 'none';
                        toggleChatBtn.classList.remove('active');
                    } else {
                        participantsSidebar.style.display = 'none';
                        chatSidebar.style.display = 'flex';
                        toggleChatBtn.classList.add('active');
                    }
                });
            }

            // –ú–∏–∫—Ä–æ—Ñ–æ–Ω - –ø—Ä—è–º–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
            const toggleAudioBtn = document.getElementById('toggleAudio');
            if (toggleAudioBtn) {
                toggleAudioBtn.addEventListener('click', toggleAudio);
            }

            // –ö–∞–º–µ—Ä–∞ - –ø—Ä—è–º–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
            const toggleVideoBtn = document.getElementById('toggleVideo');
            if (toggleVideoBtn) {
                toggleVideoBtn.addEventListener('click', toggleVideo);
            }

            // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞
            const toggleScreenBtn = document.getElementById('toggleScreen');
            if (toggleScreenBtn) {
                toggleScreenBtn.addEventListener('click', toggleScreenShare);
            }

            // –î–æ—Å–∫–∞
            const toggleWhiteboardBtn = document.getElementById('toggleWhiteboardBtn');
            if (toggleWhiteboardBtn) {
                toggleWhiteboardBtn.addEventListener('click', toggleWhiteboard);
            }

            // –í—ã—Ö–æ–¥ –∏–∑ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏
            const leaveCallBtn = document.getElementById('leaveCall');
            if (leaveCallBtn) {
                leaveCallBtn.addEventListener('click', function() {
                    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å –≤—Å—Ç—Ä–µ—á—É?')) {
                        leaveConference();
                    }
                });
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏
            const expandLeftPanelBtn = document.getElementById('expandLeftPanel');
            const leftPanel = document.getElementById('leftPanel');
            const centerPanel = document.getElementById('centerPanel');

            if (expandLeftPanelBtn && leftPanel) {
                expandLeftPanelBtn.addEventListener('click', function() {
                    leftPanel.classList.toggle('collapsed');
                    centerPanel.classList.toggle('expanded');
                });
            }
        }

        // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ (–ù–ï –≤–ª–∏—è–µ—Ç –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –∫–∞–º–µ—Ä—É)
        async function toggleScreenShare() {
            try {
                if (!mediaState.screenSharing) {
                    // –ó–∞–ø—É—Å–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
                    screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: true,
                        audio: false // –ù–µ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –∞—É–¥–∏–æ —Å —ç–∫—Ä–∞–Ω–∞
                    });
                    
                    const screenShareVideo = document.getElementById('screenShareVideo');
                    
                    if (screenShareVideo) {
                        screenShareVideo.srcObject = screenStream;
                    }
                    
                    // –í–ê–ñ–ù–û: –ù–ï –º–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∏ –∫–∞–º–µ—Ä—ã
                    mediaState.screenSharing = true;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –≤–∏–¥–µ–æ
                    updateMainVideoDisplay();
                    
                    document.getElementById('toggleScreen').classList.add('active');
                    showNotification('–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –Ω–∞—á–∞—Ç–∞');
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                    screenStream.getVideoTracks()[0].onended = () => {
                        stopScreenShare();
                    };
                    
                } else {
                    stopScreenShare();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞:', error);
                if (error.name === 'NotAllowedError') {
                    showNotification('–î–æ—Å—Ç—É–ø –∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
                } else {
                    showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é —ç–∫—Ä–∞–Ω–∞');
                }
            }
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
        function stopScreenShare() {
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }
            
            mediaState.screenSharing = false;
            const toggleScreenBtn = document.getElementById('toggleScreen');
            
            if (toggleScreenBtn) {
                toggleScreenBtn.classList.remove('active');
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –≤–∏–¥–µ–æ
            updateMainVideoDisplay();
            
            showNotification('–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
        }

        // –í—ã—Ö–æ–¥ –∏–∑ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏
        function leaveConference() {
            console.log('–í—ã—Ö–æ–¥ –∏–∑ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏');
            
            if (socket) {
                socket.emit('leave-room', {
                    roomUrl: roomUrl
                });
            }
            
            Object.keys(peerConnections).forEach(userId => {
                removePeerConnection(userId);
            });
            
            stopAllMedia();
            
            if (socket) {
                socket.disconnect();
            }
            
            window.location.href = '/';
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–æ–≤
        function stopAllMedia() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }
            if (speakingCheckInterval) {
                clearInterval(speakingCheckInterval);
                speakingCheckInterval = null;
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
                analyser = null;
            }
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏
            mediaState.whiteboardActive = false;
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–¥–∏–∞
            mediaState.audioEnabled = false;
            mediaState.videoEnabled = false;
            mediaState.screenSharing = false;
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ layout
        function setupAdaptiveLayout() {
            function handleResize() {
                const width = window.innerWidth;
                const leftPanel = document.getElementById('leftPanel');
                const centerPanel = document.getElementById('centerPanel');
                const expandLeftPanelBtn = document.getElementById('expandLeftPanel');

                if (width <= 768) {
                    if (leftPanel) leftPanel.classList.add('collapsed');
                    if (centerPanel) centerPanel.classList.add('expanded');
                    if (expandLeftPanelBtn) expandLeftPanelBtn.style.display = 'flex';
                } else {
                    if (leftPanel) leftPanel.classList.remove('collapsed');
                    if (centerPanel) centerPanel.classList.remove('expanded');
                    if (expandLeftPanelBtn) expandLeftPanelBtn.style.display = 'none';
                }
            }

            window.addEventListener('resize', handleResize);
            handleResize();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        function updateParticipantCount() {
            const remoteParticipants = document.querySelectorAll('.remote-user').length;
            const totalParticipants = remoteParticipants + 1;
            document.getElementById('participantCount').textContent = `üë• ${totalParticipants}`;
            document.getElementById('participantsCount').textContent = totalParticipants;
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–∞—Ç–æ–º
        function handleChatInputKeypress(event) {
            if (event.key === 'Enter' && !event.ctrlKey && !event.shiftKey) {
                event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ –æ–±—ã—á–Ω–æ–º Enter
                sendChatMessage();
            }
            // Ctrl+Enter –∏–ª–∏ Shift+Enter –±—É–¥–µ—Ç –¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
        }

        // –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∞–∑–º–µ—Ä textarea
        function autoResizeTextarea() {
            const textarea = document.getElementById('chatInput');
            if (textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }
        }

        // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∞–≤—Ç–æ—Ä–∞–∑–º–µ—Ä–∞
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('input', autoResizeTextarea);
            }
        });

        function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (message) {
                addChatMessage('–í—ã', message, true);
                chatInput.value = '';
                
                // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket
                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', message);
            }
        }

        function addChatMessage(sender, text, isOwn = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = isOwn ? 'message own-message' : 'message remote-message';
            
            const now = new Date();
            const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                             now.getMinutes().toString().padStart(2, '0');
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">${sender}</span>
                    <span class="message-time">${timeString}</span>
                </div>
                <div class="message-text">${text}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'media-notification';
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(20px);
                padding: 12px 24px;
                border-radius: 25px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
                z-index: 1001;
                font-weight: 600;
                color: #333;
                animation: slideDown 0.3s ease;
                border: 1px solid rgba(255, 255, 255, 0.2);
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }

        // –ü–æ–∫–∞–∑ –æ—à–∏–±–æ–∫
        function showError(message) {
            showNotification(`–û—à–∏–±–∫–∞: ${message}`);
        }

        // –£–±—Ä–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è createMediaPermissionButton()

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', function() {
            stopAllMedia();
        });
    </script>
>>>>>>> Stashed changes
</body>
</html>