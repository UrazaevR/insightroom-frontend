<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный кабинет - Insight Room</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/personal-cabinet.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/toast.css') }}">
</head>
<body>
    <div class="animated-bg"></div>
    
    <div class="toast-container" id="toastContainer"></div>
    
    <header class="header">
        <div class="container">
            <div class="logo">
                <a href="/" class="logo-link">Insight Room</a>
            </div>
            
            <nav class="nav">
                <div class="user-menu">
                    <button class="settings-btn" onclick="toggleSettings()">
                        <img src="{{ url_for('static', filename='images/settings-icon.png') }}" alt="Настройки">
                    </button>
                    
                    <div class="user-info">
                        <span class="user-name">{{ user_name }}</span>
                        <span class="user-login">{{ user_login }}</span>
                    </div>
                    <button class="logout-btn" onclick="handleLogout()">Выйти</button>
                </div>
            </nav>

            <div id="settingsDropdown" class="settings-dropdown">
                <div class="settings-section">
                    <h4>Тема</h4>
                    <div class="theme-switcher">
                        <button class="theme-option active" data-theme="light" onclick="changeTheme('light')">
                            Светлая
                        </button>
                        <button class="theme-option" data-theme="dark" onclick="changeTheme('dark')">
                            Темная
                        </button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h4>Конфиденциальность</h4>
                    <div class="privacy-setting">
                        <label>Номер телефона</label>
                        <select class="privacy-select" onchange="updatePrivacySetting('phone', this.value)">
                            <option value="everyone">Все</option>
                            <option value="contacts">Только контакты</option>
                            <option value="nobody">Никто</option>
                        </select>
                    </div>
                    <div class="privacy-setting">
                        <label>Фото профиля</label>
                        <select class="privacy-select" onchange="updatePrivacySetting('photo', this.value)">
                            <option value="everyone">Все</option>
                            <option value="contacts">Только контакты</option>
                            <option value="nobody">Никто</option>
                        </select>
                    </div>
                    <div class="privacy-setting">
                        <label>Email</label>
                        <select class="privacy-select" onchange="updatePrivacySetting('email', this.value)">
                            <option value="everyone">Все</option>
                            <option value="contacts">Только контакты</option>
                            <option value="nobody">Никто</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container dashboard-container">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Личный кабинет</h1>
                <p class="dashboard-subtitle">Добро пожаловать, {{ user_name }}</p>
            </div>

            <div class="dashboard-layout">
                <div class="dashboard-sidebar">
                    <section class="sidebar-section">
                        <div class="section-header">
                            <div class="section-title">
                                <img src="{{ url_for('static', filename='images/calendar-icon.png') }}" alt="Мои встречи" class="section-icon">
                                <h3>Мои встречи</h3>
                            </div>
                            <span class="section-count">{{ sessions_count }}</span>
                        </div>
                        <div class="compact-list">
                            {% for meeting in current_meetings %}
                            <div class="list-item" data-meeting-id="{{ meeting.id }}" data-date="{{ meeting.date }}" data-time="{{ meeting.time }}">
                                <div class="item-main clickable" onclick="showMeetingInfo('{{ meeting.id}}')">
                                    <div class="item-header">
                                        <div class="item-title-wrapper">
                                            <h3 class="item-title" title="{{ meeting.title }}">{{ meeting.title }}</h3>
                                            <span class="status-badge">{{ meeting.status }}</span>
                                        </div>
                                        {% if meeting.description %}
                                        <p class="item-description" title="{{ meeting.description }}">
                                            {{ meeting.description[:40] }}{% if meeting.description|length > 40 %}...{% endif %}
                                        </p>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="item-actions horizontal">
                                    <button type="button" class="action-btn small primary" onclick="joinMeeting('{{ meeting.id}}', event)" title="Присоединиться к встрече">
                                        Присоединиться
                                    </button>
                                    <button type="button" class="action-btn small icon-btn" onclick="copyMeetingLink('{{ meeting.id }}', event)" title="Копировать ссылку">
                                        Ссылка
                                    </button>
                                    
                                    <!-- Три точки с выпадающим меню -->
                                    <div class="meeting-actions-dropdown">
                                        <button class="dots-btn" onclick="toggleMeetingActions('{{ meeting.id }}', event)">⋮</button>
                                        <div class="dropdown-menu" id="dropdown-{{ meeting.id }}">
                                            <button class="dropdown-item" 
                                                    data-meeting-id="{{ meeting.id }}"
                                                    data-meeting-title="{{ meeting.title }}"
                                                    data-meeting-description="{{ meeting.description if meeting.description else '' }}"
                                                    onclick="openEditMeetingModalFromButton(this)">
                                                Изменить
                                            </button>
                                            <button class="dropdown-item delete" onclick="confirmDeleteMeeting('{{ meeting.id }}', '{{ meeting.title }}')">
                                                Удалить
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% if not current_meetings %}
                        <div class="empty-state">
                            <p>Нет встреч</p>
                        </div>
                        {% endif %}
                        <div class="section-footer">
                            <button type="button" class="text-btn small" onclick="openScheduleModal()">+ Запланировать встречу</button>
                        </div>
                    </section>
                </div>

                <div class="dashboard-main">
                    <section class="dashboard-section">
                        <div class="section-header">
                            <div class="section-title">
                                <img src="{{ url_for('static', filename='images/calendar-icon.png') }}" alt="Все встречи" class="section-icon">
                                <h2>Все встречи</h2>
                            </div>
                            <span class="section-count">{{ all_meetings_count }}</span>
                        </div>
                        
                        <div class="compact-list">
                            {% for meeting in all_meetings %}
                            <div class="list-item" data-meeting-id="{{ meeting.id }}" data-date="{{ meeting.date }}" data-time="{{ meeting.time }}">
                                <div class="item-main clickable" onclick="showMeetingInfo('{{ meeting.id}}', event)">
                                    <div class="item-header">
                                        <div class="item-title-wrapper">
                                            <h3 class="item-title" title="{{ meeting.title }}">{{ meeting.title }}</h3>
                                            <span class="status-badge">{{ meeting.status }}</span>
                                        </div>
                                        {% if meeting.description %}
                                        <p class="item-description" title="{{ meeting.description }}">
                                            {{ meeting.description[:40] }}{% if meeting.description|length > 40 %}...{% endif %}
                                        </p>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="item-actions horizontal">
                                    <button type="button" class="action-btn small primary" onclick="joinMeeting('{{ meeting.id}}', event)" title="Присоединиться к встрече">
                                        Присоединиться
                                    </button>
                                    <button type="button" class="action-btn small icon-btn" onclick="copyMeetingLink('{{ meeting.id }}', event)" title="Копировать ссылку">
                                        Ссылка
                                    </button>
                                    <!-- Троеточие УДАЛЕНО из "Все встречи" -->
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% if not all_meetings %}
                        <div class="empty-state">
                            <p>Нет встреч</p>
                        </div>
                        {% endif %}
                    </section>
                </div>

                <div class="dashboard-sidebar">
                    <section class="sidebar-section">
                        <div class="section-header">
                            <div class="section-title">
                                <img src="{{ url_for('static', filename='images/actions-icon.png') }}" alt="Действия" class="section-icon">
                                <h3>Быстрые функции</h3>
                            </div>
                        </div>
                        <div class="quick-actions-compact">
                            <button type="button" class="quick-action-btn" onclick="openJoinModal()">
                                <img src="{{ url_for('static', filename='images/join-icon.png') }}" alt="Присоединиться" class="action-icon">
                                <span>Присоединиться</span>
                            </button>
                            <button type="button" class="quick-action-btn" onclick="openCreateRoomModal()">
                                <img src="{{ url_for('static', filename='images/create-icon.png') }}" alt="Создать комнату" class="action-icon">
                                <span>Создать комнату</span>
                            </button>
                        </div>
                    </section>

                    <section class="sidebar-section">
                        <div class="section-header">
                            <div class="section-title">
                                <img src="{{ url_for('static', filename='images/contacts-icon.png') }}" alt="Контакты" class="section-icon">
                                <h3>Контакты</h3>
                            </div>
                            <span class="section-count">{{ contacts_count }}</span>
                        </div>
                        <div class="contacts-compact">
                            {% for contact in contacts %}
                            <div class="contact-item">
                                <div class="contact-avatar small">{{ contact.initials }}</div>
                                <div class="contact-info">
                                    <span class="contact-name">{{ contact.name }}</span>
                                    <span class="contact-login">{{ contact.login }}</span>
                                </div>
                                <div class="contact-actions">
                                    <button type="button" class="contact-edit-btn" onclick="openEditContactModal('{{ contact.id }}', '{{ contact.name }}', '{{ contact.login }}')">✎</button>
                                    <button type="button" class="contact-delete-btn" onclick="deleteContact('{{ contact.id }}', '{{ contact.name }}')">✕</button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% if not contacts %}
                        <div class="empty-state">
                            <p>Нет контактов</p>
                        </div>
                        {% endif %}
                        <div class="section-footer">
                            <button type="button" class="text-btn small" onclick="openAddContactModal()">+ Добавить контакт</button>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </main>

    <!-- Модальные окна -->
    <div id="scheduleModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Запланировать встречу</h2>
                <button class="close-btn" onclick="closeScheduleModal()">×</button>
            </div>
            <form id="scheduleForm" class="modal-form">
                <div class="form-group">
                    <label class="form-label">Название встречи</label>
                    <input type="text" class="form-input" id="meetingTitle" placeholder="Введите название встречи" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Дата</label>
                        <input type="date" class="form-input" id="meetingDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Время</label>
                        <input type="time" class="form-input" id="meetingTime" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Описание (необязательно)</label>
                    <textarea class="form-textarea" id="meetingDescription" placeholder="О чем будет встреча.."></textarea>
                </div>
                
                <button type="submit" class="modal-btn">Запланировать встречу</button>
            </form>
        </div>
    </div>

    <div id="editMeetingModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Изменить встречу</h2>
                <button class="close-btn" onclick="closeEditMeetingModal()">×</button>
            </div>
            <form id="editMeetingForm" class="modal-form">
                <input type="hidden" id="editMeetingId" value="">
                <div class="form-group">
                    <label class="form-label">Название встречи</label>
                    <input type="text" class="form-input" id="editMeetingTitle" placeholder="Введите название встречи" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Дата</label>
                        <input type="date" class="form-input" id="editMeetingDate">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Время</label>
                        <input type="time" class="form-input" id="editMeetingTime">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Описание (необязательно)</label>
                    <textarea class="form-textarea" id="editMeetingDescription" placeholder="О чем будет встреча..."></textarea>
                </div>
                
                <div class="button-group">
                    <button type="button" class="modal-btn danger-btn" onclick="deleteMeetingFromModal()">Удалить встречу</button>
                    <button type="submit" class="modal-btn">Сохранить изменения</button>
                </div>
            </form>
        </div>
    </div>

    <div id="joinModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Присоединиться к встрече</h2>
                <button class="close-btn" onclick="closeJoinModal()">×</button>
            </div>
            <form id="joinForm" class="modal-form">
                <div class="form-group">
                    <label class="form-label">Идентификатор встречи или ссылка</label>
                    <input type="text" class="form-input" name="meeting_id" placeholder="Введите идентификатор встречи или ссылку" required>
                </div>
                <button type="submit" class="modal-btn">Присоединиться</button>
            </form>
        </div>
    </div>

    <div id="createRoomModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Создать комнату</h2>
                <button class="close-btn" onclick="closeCreateRoomModal()">×</button>
            </div>
            <form id="createRoomForm" class="modal-form">
                <div class="form-group">
                    <label class="form-label">Название комнаты</label>
                    <input type="text" class="form-input" name="room_name" placeholder="Введите название комнаты" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Описание (необязательно)</label>
                    <textarea class="form-textarea" name="room_description" placeholder="Опишите назначение комнаты..."></textarea>
                </div>
                
                <button type="submit" class="modal-btn">Создать комнату</button>
            </form>
        </div>
    </div>

    <div id="addContactModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Добавить контакт</h2>
                <button class="close-btn" onclick="closeAddContactModal()">×</button>
            </div>
            <form id="addContactForm" class="modal-form">
                <div class="form-group">
                    <label class="form-label">Имя контакта</label>
                    <input type="text" class="form-input" id="contactName" placeholder="Введите имя контакта" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Логин пользователя</label>
                    <input type="text" class="form-input" id="contactLogin" placeholder="Введите логин пользователя" required>
                </div>
                
                <button type="submit" class="modal-btn">Добавить контакт</button>
            </form>
        </div>
    </div>

    <div id="editContactModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Изменить контакт</h2>
                <button class="close-btn" onclick="closeEditContactModal()">×</button>
            </div>
            <form id="editContactForm" class="modal-form">
                <input type="hidden" id="editContactId" value="">
                <div class="form-group">
                    <label class="form-label">Новое имя контакта</label>
                    <input type="text" class="form-input" id="editContactName" placeholder="Введите имя контакта" required>
                </div>
                <div class="button-group">
                    <button type="submit" class="modal-btn">Сохранить изменения</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='JS/auth.js') }}"></script>
    <script>
        // Функция для логирования в консоль
        function logUserInput(formName, data) {
            console.log(`[FORM_SUBMIT] ${formName}`);
            for (const [key, value] of Object.entries(data)) {
                console.log(`  ${key}: ${value}`);
            }
            console.log('---');
        }

        // Функция для показа toast-уведомлений
        function showToast(title, description, type = 'success', duration = 5000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const formattedDescription = description ? description.replace(/\n/g, '<br>') : '';
            
            toast.innerHTML = `
                <div class="toast-icon">${type === 'success' ? '✓' : type === 'error' ? '✕' : '⚠'}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    ${formattedDescription ? `<div class="toast-description">${formattedDescription}</div>` : ''}
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;
            toastContainer.appendChild(toast);
            if (duration > 0) {
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.classList.add('hiding');
                        setTimeout(() => toast.remove(), 300);
                    }
                }, duration);
            }
        }

        // --- Вспомогательные функции UI (без изменений) ---

        function showMeetingInfo(meetingId, event) {
            if (event) { event.stopPropagation(); event.preventDefault(); }
            const meetingElement = document.querySelector(`[data-meeting-id="${meetingId}"]`);
            if (meetingElement) {
                const title = meetingElement.querySelector('.item-title').textContent || 'Нет названия';
                const description = meetingElement.querySelector('.item-description')?.textContent || 'Нет описания';
                const status = meetingElement.querySelector('.status-badge') ? meetingElement.querySelector('.status-badge').textContent : 'Неизвестен';
                const meetingDate = meetingElement.dataset.date || 'Не указана';
                const meetingTime = meetingElement.dataset.time || 'Не указано';
                
                const meetingInfo = `<b>ID:</b> ${meetingId}\n<b>Название:</b> ${title}\n<b>Статус:</b> ${status}\n<b>Дата:</b> ${meetingDate} ${meetingTime}\n<b>Описание:</b> ${description}`;
                showToast('Информация о встрече', meetingInfo, 'info', 6000);
            } else {
                showToast('Информация о встрече', `ID встречи: ${meetingId}`, 'info', 4000);
            }
        }

        function joinMeeting(meetingId, event) {
            if (event) { event.stopPropagation(); event.preventDefault(); }
            window.open(`${window.location.origin}/conference/${meetingId}`)
        }
        
        function copyMeetingLink(meetingId, event) {
            if (event) { event.stopPropagation(); event.preventDefault(); }
            navigator.clipboard.writeText(`${window.location.origin}/conference/${meetingId}`).then(() => {
                showToast('Ссылка скопирована!', ``, 'success');
            }).catch(err => {
                showToast('Ошибка копирования', 'Не удалось скопировать ссылку', 'error');
            });
        }

        function toggleMeetingActions(meetingId, event) {
            if (event) { event.stopPropagation(); event.preventDefault(); }
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                if (menu.id !== `dropdown-${meetingId}`) menu.classList.remove('show');
            });
            const dropdown = document.getElementById(`dropdown-${meetingId}`);
            dropdown.classList.toggle('show');
        }

        function confirmDeleteMeeting(meetingId, meetingTitle) {
            if (confirm(`Вы уверены, что хотите удалить встречу "${meetingTitle}"?`)) {
                deleteMeeting(meetingId);
            }
        }

        // --- ФУНКЦИИ С ЗАПРОСАМИ НА СЕРВЕР (ИЗМЕНЕНО НА authService) ---

        async function deleteMeeting(meetingId) {
            console.log(`[DELETE_MEETING] meeting.id: ${meetingId}`);
            
            // ИСПОЛЬЗУЕМ authService ВМЕСТО fetch
            const response = await authService.makeAuthenticatedRequest('api/delete-room', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({'room.id': meetingId})
            });

            // Если response null, значит рефреш не удался и юзера выкинуло на логин
            if (!response) return;

            if (response.ok) {
                showToast('Встреча удалена', '', 'success');
                const dropdown = document.getElementById(`dropdown-${meetingId}`);
                if (dropdown) dropdown.classList.remove('show');
                window.location.reload();
            } else {
                const errorData = await response.json();
                showToast('Ошибка при удалении комнаты', `${errorData.error}`, 'error');
            }
        }

        // --- Управление модальными окнами (без изменений) ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
                document.body.classList.add('modal-open');
                document.querySelectorAll('.dropdown-menu').forEach(menu => menu.classList.remove('show'));
                document.getElementById('settingsDropdown').classList.remove('show');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                document.body.classList.remove('modal-open');
            }
        }

        function openEditMeetingModal(meetingId, title, description) { return; } // Старая функция, не используется

        function openEditMeetingModalFromButton(button) {
            const meetingId = button.getAttribute('data-meeting-id');
            const title = button.getAttribute('data-meeting-title');
            const description = button.getAttribute('data-meeting-description');
            
            const dropdown = document.getElementById(`dropdown-${meetingId}`);
            if (dropdown) dropdown.classList.remove('show');
            
            document.getElementById('editMeetingId').value = meetingId;
            document.getElementById('editMeetingTitle').value = title;
            document.getElementById('editMeetingDescription').value = description;
            openModal('editMeetingModal');
        }

        function closeEditMeetingModal() { closeModal('editMeetingModal'); }

        function deleteMeetingFromModal() {
            const meetingId = document.getElementById('editMeetingId').value;
            const meetingTitle = document.getElementById('editMeetingTitle').value;
            if (confirm(`Вы уверены, что хотите удалить встречу "${meetingTitle}"?`)) {
                deleteMeeting(meetingId);
                closeEditMeetingModal();
            }
        }

        function openEditContactModal(contactId, name, login) {
            document.getElementById('editContactId').value = contactId;
            document.getElementById('editContactName').value = decodeHTMLEntities(name);
            openModal('editContactModal');
        }

        function closeEditContactModal() { closeModal('editContactModal'); }

        function decodeHTMLEntities(text) {
            if (!text) return '';
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            return textarea.value;
        }

        async function deleteContact(contactId, contactName) {
            if (confirm(`Вы уверены, что хотите удалить контакт "${contactName}"?`)) {
                
                // ИСПОЛЬЗУЕМ authService
                const response = await authService.makeAuthenticatedRequest('api/delete-contact', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({'contactId': contactId})
                });

                if (!response) return;

                if (response.ok) {
                    showToast('Контакт удален', `Контакт "${contactName}" удален`, 'success');
                    window.location.reload();
                } else {
                    const errorData = await response.json();
                    showToast('Ошибка при удалении контакта', `${errorData.error}`, 'error');
                }
            }
        }

        function changeTheme(theme) {
            document.body.className = theme + '-theme';
            localStorage.setItem('theme', theme);
            updateThemeButtons(theme);
        }

        function updateThemeButtons(activeTheme) {
            document.querySelectorAll('.theme-option').forEach(button => {
                if (button.getAttribute('data-theme') === activeTheme) button.classList.add('active');
                else button.classList.remove('active');
            });
        }

        function openScheduleModal() { openModal('scheduleModal'); document.getElementById('meetingDate').min = new Date().toISOString().split('T')[0]; }
        function closeScheduleModal() { closeModal('scheduleModal'); }
        function openJoinModal() { openModal('joinModal'); }
        function closeJoinModal() { closeModal('joinModal'); }
        function openCreateRoomModal() { openModal('createRoomModal'); }
        function closeCreateRoomModal() { closeModal('createRoomModal'); }
        function openAddContactModal() { openModal('addContactModal'); document.getElementById('addContactForm').reset(); }
        function closeAddContactModal() { closeModal('addContactModal'); }

        // --- ОБРАБОТЧИКИ ФОРМ (ИЗМЕНЕНО НА authService) ---

        document.getElementById('scheduleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = {
                'room.name': document.getElementById('meetingTitle').value,
                'room.activation_time': `${document.getElementById('meetingDate').value}T${document.getElementById('meetingTime').value}`,
                'room.description': document.getElementById('meetingDescription').value || '(empty)'
            };
            
            // ИСПОЛЬЗУЕМ authService
            const response = await authService.makeAuthenticatedRequest('api/create-room', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (!response) return;

            if (response.ok) {
                showToast('Встреча запланирована!', 'Данные будут обновлены', 'success');
                window.location.reload();
            } else {
                const errorData = await response.json();
                showToast('Ошибка при планировании комнаты', `${errorData.error}`, 'error');
            }
            closeScheduleModal();
        });

        document.getElementById('editMeetingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const meetingId = document.getElementById('editMeetingId').value;
            const formData = {
                'room.id': meetingId,
                'room.name': document.getElementById('editMeetingTitle').value,
                'room.activation_time': `${document.getElementById('editMeetingDate').value}T${document.getElementById('editMeetingTime').value}`,
                'room.description': document.getElementById('editMeetingDescription').value || '(empty)'
            };
            
            // ИСПОЛЬЗУЕМ authService
            const response = await authService.makeAuthenticatedRequest('/api/refactor_room', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(formData)
            });

            if (!response) return;

            if (response.ok) {
                showToast('Изменения сохранены', 'Данные встречи обновлены', 'success');
                window.location.reload();
            } else {
                const errorData = await response.json();
                showToast('Ошибка при изменении комнаты', `${errorData.error}`, 'error');
            }
            closeEditMeetingModal();
        });

        document.getElementById('editContactForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const contactId = document.getElementById('editContactId').value;
            const formData = {
                'contact.id': contactId,
                'contact.name': document.getElementById('editContactName').value
            };
            
            // ИСПОЛЬЗУЕМ authService
            const response = await authService.makeAuthenticatedRequest('/api/edit_contact', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(formData)
            });

            if (!response) return;

            if (response.ok) {
                showToast('Изменения сохранены', 'Данные контакта обновлены', 'success');
                window.location.reload();
            } else {
                const errorData = await response.json();
                showToast('Ошибка при изменении контакта', `${errorData.error}`, 'error');
            }
            closeEditContactModal();
        });

        document.getElementById('joinForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const meetingId = this.querySelector('input[name="meeting_id"]').value;
            window.open(`${window.location.origin}/conference/${meetingId}`)
            showToast('Присоединение', `Подключаемся к встрече`, 'success');
            closeJoinModal();
        });

        document.getElementById('createRoomForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = {
                'room.name': formData.get('room_name'),
                'room.description': formData.get('room_description') || '(empty)',
                'room.activation_time': 'now'
            };
            
            // ИСПОЛЬЗУЕМ authService
            const response = await authService.makeAuthenticatedRequest('api/create-room', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!response) return;

            if (response.ok) {
                showToast('Комната создана!', 'Данные будут обновлены', 'success');
                window.location.reload();
            } else {
                const errorData = await response.json();
                showToast('Ошибка при создании комнаты', `${errorData.error}`, 'error');
            }
            closeCreateRoomModal();
        });

        document.getElementById('addContactForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const contactName = document.getElementById('contactName').value.trim();
            const contactLogin = document.getElementById('contactLogin').value.trim();
            
            const formData = {
                'contact.name': contactName,
                'contact.login': contactLogin
            };
            
            if (!contactName || !contactLogin) {
                showToast('Ошибка', 'Заполните все поля', 'error');
                return;
            }
            
            // ИСПОЛЬЗУЕМ authService
            const response = await authService.makeAuthenticatedRequest('api/add_contact', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (!response) return;

            if (response.ok) {
                showToast('Контакт добавлен!', `${contactName} добавлен в контакты`, 'success');
                window.location.reload();
            } else {
                const errorData = await response.json();
                showToast('Ошибка при добавлении контакта', `${errorData.error}`, 'error');
            }
            closeAddContactModal();
        });

        function toggleSettings() {
            document.getElementById('settingsDropdown').classList.toggle('show');
        }

        function updatePrivacySetting(setting, value) {
            console.log(`[PRIVACY_SETTING] ${setting}: ${value}`);
        }

        function handleLogout() {
            authService.logout();
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            changeTheme(savedTheme);
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.meeting-actions-dropdown') && !e.target.closest('.settings-btn')) {
                    document.querySelectorAll('.dropdown-menu').forEach(menu => menu.classList.remove('show'));
                    if (!e.target.closest('.settings-dropdown')) {
                        document.getElementById('settingsDropdown').classList.remove('show');
                    }
                }
            });
            
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) closeModal(this.id);
                });
            });
        });
    </script>